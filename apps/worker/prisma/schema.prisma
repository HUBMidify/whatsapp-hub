generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id               String            @id @default(cuid())
  email            String            @unique
  name             String
  password         String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  metaAccounts     MetaAccount[]
  trackingLinks    TrackingLink[]
  whatsAppSessions WhatsAppSession[]

  @@index([email])
}

enum OriginLabel {
  META_ADS
  GOOGLE_ADS
  SOCIAL
  OTHER
  UNTRACKED
}

enum OriginReason {
  GCLID
  FBCLID
  FBC
  PLATFORM
  UTM_REGEX
  FALLBACK_MATCHED
  UNTRACKED
}

model MetaAccount {
  id             String   @id @default(cuid())
  userId         String
  accessToken    String
  pixelId        String
  adAccountId    String
  tokenExpiresAt DateTime
  createdAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model WhatsAppSession {
  id          String    @id @default(cuid())
  userId      String
  credentials Json
  status      String    @default("DISCONNECTED")
  lastPingAt  DateTime?
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  whatsappNumber String?
  whatsappJid    String?

  @@index([userId])
  @@index([status])
  @@index([whatsappNumber])
  @@index([whatsappJid])
}

model TrackingLink {
  id               String     @id @default(cuid())
  userId           String
  name             String
  slug             String
  destinationUrl   String?
  whatsappNumber   String?
  preFilledMessage String?
  utmSource        String?
  utmMedium        String?
  utmCampaign      String?
  utmTerm          String?
  utmContent       String?
  archivedAt       DateTime?
  createdAt        DateTime   @default(now())
  clickLogs        ClickLog[]
  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  platform         String?

  @@index([userId])
  @@index([slug])
  @@index([archivedAt])
  @@index([platform])
  @@unique([userId, slug])
}

model ClickSession {
  id          String   @id @default(cuid())
  sessionId   String   @unique
  gclid       String?
  fbclid      String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmContent  String?
  utmTerm     String?
  userAgent   String?
  ip          String?
  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @updatedAt

  clickLogs   ClickLog[]

  @@index([gclid])
  @@index([fbclid])
  @@index([firstSeenAt])
  @@index([lastSeenAt])
}


model ClickLog {
  id             String         @id @default(cuid())
  shortId        String? @unique
  trackingLinkId String?
  clickSessionId String?
  clickSession   ClickSession? @relation(fields: [clickSessionId], references: [id])
  fbclid         String?
  fbc            String?
  fbp            String?
  gclid          String?
  utmSource      String?
  utmMedium      String?
  utmCampaign    String?
  utmTerm        String?
  utmContent     String?
  gadSource      String?
  referrer       String?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime       @default(now())
  trackingLink   TrackingLink?  @relation(fields: [trackingLinkId], references: [id])
  conversations  Conversation[]

  @@index([trackingLinkId])
  @@index([clickSessionId])
  @@index([fbclid])
  @@index([gclid])
  @@index([createdAt])
  @@index([trackingLinkId, createdAt])
}

model Lead {
  id            String         @id @default(cuid())
  phone         String         @unique
  name          String?
  firstSeenAt   DateTime       @default(now())
  lastSeenAt    DateTime       @updatedAt
  conversations Conversation[]

  // Attribution state (persisted)
  firstTrackedConversationId String?
  firstTrackedOriginLabel    OriginLabel?

  lastTrackedConversationId  String?
  lastTrackedOriginLabel     OriginLabel?

  @@index([phone])
  @@index([firstTrackedOriginLabel])
  @@index([lastTrackedOriginLabel])
}

model Conversation {
  id              String    @id @default(cuid())
  leadId          String
  clickLogId      String?
  messageText     String
  matchMethod     String?
  matchConfidence Float?
  originLabel     OriginLabel?
  originReason    OriginReason?
  clickToMessageLatencySeconds Int?
  capiEventId     String?
  capiStatus      String?
  capiSentAt      DateTime?
  createdAt       DateTime  @default(now())
  clickLog        ClickLog? @relation(fields: [clickLogId], references: [id])
  lead            Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([clickLogId])
  @@index([createdAt])
  @@index([capiStatus])
  
}
